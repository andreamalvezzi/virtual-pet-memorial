// ==============================
// PRISMA SCHEMA
// ==============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUM
// ==============================

enum MemorialPlan {
  FREE
  MEDIUM
  PLUS
}

enum GraveTier {
  FREE
  MEDIUM
  PLUS
}

// ==============================
// MODELS
// ==============================

model User {
  id        Int          @id @default(autoincrement())
  email     String       @unique
  password  String

  // Piano account (source of truth)
  plan      MemorialPlan @default(FREE)

  // Email verification (pronta per invio email in futuro)
  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?   @unique
  emailVerifyExpiry DateTime?

  createdAt DateTime @default(now())

  memorials Memorial[]
}

model Memorial {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  // ==========================
  // DATI DEL PET
  // ==========================
  petName   String
  species   String

  // ==========================
  // MOMENTO DEL RICORDO
  // ==========================
  deathDate DateTime

  // ==========================
  // TESTO MEMORIALE
  // ==========================
  epitaph   String

  // ==========================
  // MEDIA (cover / principale)
  // ==========================
  imageUrl  String?

  // ==========================
  // LAPIDE
  // ==========================
  graveStyleKey String @default("classic")
  graveStyle    GraveStyle? @relation(fields: [graveStyleKey], references: [key])

  // ==========================
  // VISIBILITÃ€
  // ==========================
  isPublic Boolean @default(false)

  // ==========================
  // URL PUBBLICO
  // ==========================
  slug     String  @unique

  // ==========================
  // RELATIONS
  // ==========================
  images   MemorialImage[]
  videos   MemorialVideo[]

  // ==========================
  // META
  // ==========================
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model MemorialImage {
  id         Int      @id @default(autoincrement())
  memorialId Int
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  imageUrl   String
  createdAt  DateTime @default(now())

  @@index([memorialId])
}

model MemorialVideo {
  id         Int      @id @default(autoincrement())
  memorialId Int
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  videoUrl   String
  createdAt  DateTime @default(now())

  @@index([memorialId])
}

model GraveStyle {
  // key usata dal Memorial (string stabile, facile da cambiare in futuro)
  key        String   @id

  label      String
  tier       GraveTier @default(FREE)

  // opzionali per prove UI
  previewUrl String?
  sortOrder  Int      @default(0)
  isActive   Boolean  @default(true)

  memorials  Memorial[]
}
